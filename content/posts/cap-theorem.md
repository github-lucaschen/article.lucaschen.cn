---
title: 'Cap Theorem'
description: 'cap-theorem'
keywords: 'cap,theorem'

date: 2024-03-21T14:47:43+08:00

categories:
  - Doc
tags:
  - CAP
---

记录什么是CAP 定理。

<!--more-->

## 理论

对于一个分布式计算系统来说，不可能同时满足以下三点：

1. 一致性（Consistency） （等同于所有节点访问同一份最新的数据副本）
2. 可用性（Availability）（每次请求都能获取到非错的响应——但是不保证获取的数据为最新数据）
3. 分区容错性（Partition tolerance）（以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在 C 和 A 之间做出选择。）

根据定理，分布式系统只能满足三项中的两项而不可能满足全部三项。

理解 CAP 理论的最简单方式是想象两个节点分处分区两侧。

- 允许至少一个节点更新状态会导致数据不一致，即丧失了 C 性质。
- 如果为了保证数据一致性，将分区一侧的节点设置为不可用，那么又丧失了 A 性质。
- 除非两个节点可以互相通信，才能既保证 C 又保证 A，这又会导致丧失 P 性质。

## AP

当网络分区出现后，为了保证可用性，系统 B 可以返回旧值，保证系统的可用性。

此时违背了一致性 C 的要求，只满足可用性和分区容错，即 AP。

## CP

当网络分区出现后，为了保证一致性，就必须拒绝请求，否则无法保证一致性。

此时违背了可用性 A 的要求，只满足一致性和分区容错，即 CP。

## 取舍

CAP 理论提出就是针对分布式数据库环境的，所以，P 这个属性是必须具备的。

P 就是在分布式环境中，由于网络的问题可能导致某个节点和其它节点失去联系，这时候就形成了 P(partition)，也就是由于网络问题，将系统的成员隔离成了 2 个区域，互相无法知道对方的状态，这在分布式环境下是非常常见的。

因为 P 是必须的，那么我们需要选择的就是 A 和 C。

在分布式环境下，为了保证系统可用性，通常都采取了复制的方式，避免一个节点损坏，导致系统不可用。那么就出现了每个节点上的数据出现了很多个副本的情况，而数据从一个节点复制到另外的节点时需要时间和要求网络畅通的，所以，当 P 发生时，也就是无法向某个节点复制数据时，这时候你有两个选择：

1. 选择可用性 A(Availability)，此时，那个失去联系的节点依然可以向系统提供服务，不过它的数据就不能保证是同步的了（失去了 C 属性）。
2. 选择一致性 C(Consistency)，为了保证数据库的一致性，我们必须等待失去联系的节点恢复过来，在这个过程中，那个节点是不允许对外提供服务的，这时候系统处于不可用状态(失去了 A 属性)。

最常见的例子是读写分离，某个节点负责写入数据，然后将数据同步到其它节点，其它节点提供读取的服务，当两个节点出现通信问题时，你就面临着选择 A（继续提供服务，但是数据不保证准确），C（用户处于等待状态，一直等到数据同步完成）。
